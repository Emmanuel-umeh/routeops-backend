datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model CityHall {
  allowImages       Boolean             @default(true)
  allowVideo        Boolean             @default(true)
  createdAt         DateTime            @default(now())
  defaultLatitude   Float?
  defaultLongitude  Float?
  description       String?
  gisFileUrl        String?
  gisFileVersion    String?
  id                String              @id @default(uuid())
  name              String?
  projects          Project[]
  updatedAt         DateTime            @updatedAt
  users             User[]
  roadRatingHistory RoadRatingHistory[]
  roadRatings       RoadRating[]
}

model RoutePoint {
  createdAt   DateTime @default(now())
  frameNumber Int?
  hazards     Hazard[]
  id          String   @id @default(uuid())
  latitude    Float?
  longitude   Float?
  project     Project? @relation(fields: [projectId], references: [id])
  projectId   String?
  timestamp   Int?
  updatedAt   DateTime @updatedAt
}

model Project {
  assignedUser        String?
  cityHall            CityHall?            @relation(fields: [cityHallId], references: [id])
  cityHallId          String?
  createdAt           DateTime             @default(now())
  createdBy           String?
  description         String?
  hazards             Hazard[]
  id                  String               @id @default(uuid())
  name                String?
  routePoints         RoutePoint[]
  scheduledDate       DateTime?
  startDate           DateTime?
  status              EnumProjectStatus?
  surveys             Survey[]
  roadRatingHistory   RoadRatingHistory[]
  updatedAt           DateTime             @updatedAt
  videoUrl            String?
}

model Remark {
  createdAt DateTime  @default(now())
  hazard    Hazard?   @relation(fields: [hazardId], references: [id])
  hazardId  String?
  id        String    @id @default(uuid())
  survey    Survey?   @relation(fields: [surveyId], references: [id])
  surveyId  String?
  text      String?
  timestamp DateTime?
  updatedAt DateTime  @updatedAt
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?
}

model Hazard {
  createdAt    DateTime    @default(now())
  createdBy    String?
  description  String?
  externalId   String?
  id           String      @id @default(uuid())
  imageUrl     String?
  latitude     Float?
  longitude    Float?
  name         String?
  project      Project?    @relation(fields: [projectId], references: [id])
  projectId    String?
  remarks      Remark[]
  routePoint   RoutePoint? @relation(fields: [routePointId], references: [id])
  routePointId String?
  severity     String?
  typeField    String?
  updatedAt    DateTime    @updatedAt

  /// Road segment / edge identifier this hazard belongs to (from geometry properties.edgeId)
  edgeId String?

  @@index([edgeId])
}

model Survey {
  assignedUser         String?
  createdAt           DateTime            @default(now())
  endTime             DateTime?
  id                  String              @id @default(uuid())
  name                String?
  project             Project?            @relation(fields: [projectId], references: [id])
  projectId           String?
  remarks             Remark[]
  remarksText         String?
  startTime           DateTime?
  status              String?
  roadRatingHistory   RoadRatingHistory[]
  // Geometry for Google Maps (GeoJSON LineString/MultiLineString)
  // Each point in the geometry can have an edgeId in its properties
  geometryJson Json?
  // Bounding box [minLng, minLat, maxLng, maxLat]
  bbox         Json?
  // Aggregates for dashboard
  eIriAvg      Float?
  lengthMeters Float?
  updatedAt    DateTime  @updatedAt

  /// All distinct edgeIds this survey has traversed (denormalized for fast edge analytics)
  edgeIds String[]

  @@index([edgeIds], type: Gin)
}

model User {
  cityHall                    CityHall?           @relation(fields: [cityHallId], references: [id])
  cityHallId                  String?
  createdAt                   DateTime            @default(now())
  email                       String?             @unique
  firstName                   String?
  id                          String              @id @default(uuid())
  isActive                    Boolean?
  lastName                    String?
  password                    String
  passwordResetToken          String?
  passwordResetTokenExpiresAt DateTime?
  remarks                     Remark[]
  role                        EnumUserRole?
  roles                       Json
  updatedAt                   DateTime            @updatedAt
  username                    String              @unique
  vehicleType                 EnumVehicleType?
  vehicleTypeOther            String?
  roadRatingHistory           RoadRatingHistory[]
}

enum EnumProjectStatus {
  active
  inactive
  completed
  pending
}

enum EnumUserRole {
  admin
  dashboard_user
  app_user
}

enum EnumVehicleType {
  passenger_cars
  garbage_truck
  bus
  police_vehicles
  other
}

model RoadRatingHistory {
  id             String   @id @default(uuid())
  entityId      String   // CityHall.id
  roadId         String   // edgeId
  eiri           Float    // EIRI rating
  userId         String   // User.id who made the survey
  surveyId       String?  // Survey.id (denormalized for analytics)
  projectId      String?  // Project.id (denormalized for analytics)
  anomaliesCount Int?     // Pre-calculated anomalies count for this survey+edge
  createdAt      DateTime @default(now())

  entity CityHall @relation(fields: [entityId], references: [id])
  user   User     @relation(fields: [userId], references: [id])
  survey Survey?  @relation(fields: [surveyId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])

  @@index([entityId, roadId])
  @@index([userId])
  @@index([createdAt])
  @@index([surveyId])
  @@index([projectId])
  @@index([roadId, createdAt]) // For time-filtered queries
}

model RoadRating {
  id        String   @id @default(uuid())
  entityId  String // CityHall.id
  roadId    String // edgeId
  eiri      Float // Current/aggregated EIRI rating
  updatedAt DateTime @default(now()) @updatedAt

  entity CityHall @relation(fields: [entityId], references: [id])

  @@unique([entityId, roadId])
  @@index([entityId])
  @@index([roadId])
}
