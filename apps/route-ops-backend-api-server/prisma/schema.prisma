datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model CityHall {
  allowImages Boolean   @default(true)
  allowVideo  Boolean   @default(true)
  createdAt   DateTime  @default(now())
  description String?
  id          String    @id @default(uuid())
  name        String?
  projects    Project[]
  updatedAt   DateTime  @updatedAt
  users       User[]
}

model RoutePoint {
  createdAt   DateTime @default(now())
  frameNumber Int?
  hazards     Hazard[]
  id          String   @id @default(uuid())
  latitude    Float?
  longitude   Float?
  project     Project? @relation(fields: [projectId], references: [id])
  projectId   String?
  timestamp   Int?
  updatedAt   DateTime @updatedAt
}

model Project {
  assignedUser  String?
  cityHall      CityHall?          @relation(fields: [cityHallId], references: [id])
  cityHallId    String?
  createdAt     DateTime           @default(now())
  createdBy     String?
  description   String?
  hazards       Hazard[]
  id            String             @id @default(uuid())
  name          String?
  routePoints   RoutePoint[]
  scheduledDate DateTime?
  status        EnumProjectStatus?
  surveys       Survey[]
  updatedAt     DateTime           @updatedAt
  videoUrl      String?
}

model Remark {
  createdAt DateTime  @default(now())
  hazard    Hazard?   @relation(fields: [hazardId], references: [id])
  hazardId  String?
  id        String    @id @default(uuid())
  survey    Survey?   @relation(fields: [surveyId], references: [id])
  surveyId  String?
  text      String?
  timestamp DateTime?
  updatedAt DateTime  @updatedAt
  user      User?     @relation(fields: [userId], references: [id])
  userId    String?
}

model Hazard {
  createdAt    DateTime    @default(now())
  createdBy    String?
  description  String?
  externalId   String?
  id           String      @id @default(uuid())
  imageUrl     String?
  latitude     Float?
  longitude    Float?
  project      Project?    @relation(fields: [projectId], references: [id])
  projectId    String?
  remarks      Remark[]
  routePoint   RoutePoint? @relation(fields: [routePointId], references: [id])
  routePointId String?
  severity     String?
  typeField    String?
  updatedAt    DateTime    @updatedAt
}

model Survey {
  assignedUser String?
  createdAt    DateTime  @default(now())
  endTime      DateTime?
  id           String    @id @default(uuid())
  name         String?
  project      Project?  @relation(fields: [projectId], references: [id])
  projectId    String?
  remarks      Remark[]
  remarksText  String?
  startTime    DateTime?
  status       String?
  // Geometry for Google Maps (GeoJSON LineString/MultiLineString)
  // Each point in the geometry can have an edgeId in its properties
  geometryJson Json?
  // Bounding box [minLng, minLat, maxLng, maxLat]
  bbox         Json?
  // Aggregates for dashboard
  eIriAvg      Float?
  lengthMeters Float?
  updatedAt    DateTime  @updatedAt
}

model User {
  cityHall   CityHall?     @relation(fields: [cityHallId], references: [id])
  cityHallId String?
  createdAt  DateTime      @default(now())
  email      String?       @unique
  firstName  String?
  id         String        @id @default(uuid())
  isActive   Boolean?
  lastName   String?
  password   String
  remarks    Remark[]
  role       EnumUserRole?
  roles      Json
  updatedAt  DateTime      @updatedAt
  username   String        @unique
}

enum EnumProjectStatus {
  active
  inactive
  completed
  pending
}

enum EnumUserRole {
  admin
  dashboard_user
  app_user
}
